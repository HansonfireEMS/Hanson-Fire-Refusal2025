<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HANSON FIRE DEPARTMENT - EMS Refusal Form</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; background:#f3f4f6 }
  .input { width:100%; padding:10px; border-radius:6px; border:1px solid #d1d5db; margin-top:6px }
  label { font-weight:600; display:block; margin-top:6px; }
  .card { background:white; padding:24px; border-radius:12px; box-shadow: 0 6px 18px rgba(0,0,0,0.06) }
  .section-title { margin-top:10px; font-weight:700; }
  canvas { touch-action:none; background:white; border:1px solid #ddd }
  @media (max-width:600px){ body{padding:12px} }
</style>
</head>
<body>
  <div class="card">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">HANSON FIRE DEPARTMENT</h1>
      <h2 class="text-lg">EMS Refusal of Medical Care & Transport Form</h2>
    </div>

    <form id="emsForm" class="mt-6 space-y-6">
      <!-- Patient Info -->
      <section>
        <div class="section-title">1. PATIENT IDENTIFICATION & INCIDENT INFORMATION</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px;">
          <div><label>Patient Name</label><input name="patient_name" class="input" /></div>
          <div><label>DOB / Age</label><input name="dob_age" class="input" /></div>
          <div><label>Address</label><input name="address" class="input" /></div>
          <div><label>Phone</label><input name="phone" class="input" /></div>
          <div><label>Incident Date</label><input name="incident_date" type="date" class="input" /></div>
          <div><label>Time</label><input name="incident_time" type="time" class="input" /></div>
          <div><label>Location</label><input name="incident_location" class="input" /></div>
          <div><label>EMS Agency / Unit</label><input name="ems_unit" class="input" /></div>
          <div><label>Provider Name(s)</label><input name="provider_names" class="input" /></div>
          <div><label>Run/Call Number</label><input name="run_number" class="input" /></div>
        </div>
      </section>

      <!-- Assessment -->
      <section>
        <div class="section-title">2. PATIENT ASSESSMENT FINDINGS</div>
        <label>Mental Status / Orientation</label>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
          <label><input type="checkbox" name="ms[]" value="A&O x4"> A&O x4</label>
          <label><input type="checkbox" name="ms[]" value="A&O x3"> A&O x3</label>
          <label><input type="checkbox" name="ms[]" value="A&O x2"> A&O x2</label>
          <label><input type="checkbox" name="ms[]" value="A&O x1"> A&O x1</label>
          <label><input type="checkbox" name="ms[]" value="Disoriented"> Disoriented</label>
          <label><input type="checkbox" name="ms[]" value="Altered"> Altered</label>
        </div>

        <label class="mt-3">Vital Signs</label>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
          <div><label>BP</label><input name="BP" class="input" /></div>
          <div><label>Pulse</label><input name="Pulse" class="input" /></div>
          <div><label>Resp</label><input name="Resp" class="input" /></div>
          <div><label>SpO2</label><input name="SpO2" class="input" /></div>
          <div><label>Glucose</label><input name="Glucose" class="input" /></div>
          <div><label>Temp</label><input name="Temp" class="input" /></div>
          <div style="grid-column:1 / -1"><label>GCS</label><input name="GCS" class="input" /></div>
        </div>

        <label class="mt-3">Additional Exam Findings</label>
        <textarea name="additional_exam" class="input" rows="3"></textarea>
      </section>

      <!-- Risks -->
      <section>
        <div class="section-title">3. EXPLANATION OF RECOMMENDED TREATMENT & RISKS</div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
          <label><input type="checkbox" name="explained[]" value="Physical exam"> Physical exam</label>
          <label><input type="checkbox" name="explained[]" value="Vital signs"> Vital signs</label>
          <label><input type="checkbox" name="explained[]" value="Medical interventions"> Medical interventions</label>
          <label><input type="checkbox" name="explained[]" value="Transport to ED"> Transport to ED</label>
        </div>
        <p style="margin-top:8px;font-size:0.95rem;color:#444">Risks explained include worsening condition, disability, death, delayed care.</p>
        <div style="margin-top:6px;">
          <label>Patient Understands Risks</label>
          <label><input type="radio" name="understands" value="Yes" checked> Yes</label>
          <label style="margin-left:12px;"><input type="radio" name="understands" value="No"> No</label>
        </div>
      </section>

      <!-- Refusal -->
      <section>
        <div class="section-title">4. SERVICES BEING REFUSED</div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
          <label><input type="checkbox" name="refused[]" value="Assessment"> Assessment</label>
          <label><input type="checkbox" name="refused[]" value="Treatment"> Treatment</label>
          <label><input type="checkbox" name="refused[]" value="Transport"> Transport</label>
          <label><input type="checkbox" name="refused[]" value="High-risk recommendation"> High-risk recommendation</label>
        </div>
        <label class="mt-2">Other</label>
        <input name="refuse_other" class="input" />
      </section>

      <!-- Acknowledgment -->
      <section>
        <div class="section-title">5. PATIENT / GUARDIAN ACKNOWLEDGMENT</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div><label>Name (typed)</label><input name="pg_name" class="input" /></div>
          <div><label>Date</label><input name="pg_date" type="date" class="input" /></div>
          <div style="grid-column:1 / -1"><label>Signature (typed)</label><input name="pg_signature" class="input" /></div>
          <div style="grid-column:1 / -1"><label>Draw Signature</label>
            <canvas id="pg_sign" width="800" height="160" style="width:100%;height:120px;background:#fff;border:1px solid #ddd"></canvas>
            <div style="margin-top:6px;"><button type="button" onclick="pgPad.clear()" class="px-2 py-1 rounded" style="background:#eee">Clear</button></div>
          </div>
          <div><label>Relationship</label><input name="pg_relationship" class="input" /></div>
        </div>
      </section>

      <!-- Witness -->
      <section>
        <div class="section-title">6. WITNESS SIGNATURE</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div><label>Name (typed)</label><input name="wit_name" class="input" /></div>
          <div><label>Date</label><input name="wit_date" type="date" class="input" /></div>
          <div style="grid-column:1 / -1"><label>Signature (typed)</label><input name="wit_signature" class="input" /></div>
          <div style="grid-column:1 / -1"><label>Draw Signature</label>
            <canvas id="wit_sign" width="800" height="160" style="width:100%;height:120px;background:#fff;border:1px solid #ddd"></canvas>
            <div style="margin-top:6px;"><button type="button" onclick="witPad.clear()" class="px-2 py-1 rounded" style="background:#eee">Clear</button></div>
          </div>
        </div>
      </section>

      <!-- Provider -->
      <section>
        <div class="section-title">7. EMS PROVIDER STATEMENT</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div><label>Name (typed)</label><input name="prov_name" class="input" /></div>
          <div><label>Date</label><input name="prov_date" type="date" class="input" /></div>
          <div style="grid-column:1 / -1"><label>Signature (typed)</label><input name="prov_signature" class="input" /></div>
          <div style="grid-column:1 / -1"><label>Draw Signature</label>
            <canvas id="prov_sign" width="800" height="160" style="width:100%;height:120px;background:#fff;border:1px solid #ddd"></canvas>
            <div style="margin-top:6px;"><button type="button" onclick="provPad.clear()" class="px-2 py-1 rounded" style="background:#eee">Clear</button></div>
          </div>
        </div>
      </section>

      <!-- Narrative -->
      <section>
        <div class="section-title">Narrative / Documentation</div>
        <textarea name="narrative" class="input" rows="5"></textarea>
      </section>

      <div>
        <button type="button" id="submitBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg text-lg font-semibold">Submit Form</button>
      </div>
    </form>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <script>
  // Initialize EmailJS
  (function(){ emailjs.init("q0E8zJYxQwO-tPG7H"); })();

  // SignaturePads
  const pgPad = new SignaturePad(document.getElementById('pg_sign'));
  const witPad = new SignaturePad(document.getElementById('wit_sign'));
  const provPad = new SignaturePad(document.getElementById('prov_sign'));

  // helper to collect form data (handles checkbox groups)
  function collectFormData() {
    const form = document.getElementById('emsForm');
    const fd = new FormData(form);
    const obj = {};

    for (const [k, v] of fd.entries()) {
      // turn repeated names into arrays
      if (k.endsWith('[]')) {
        const name = k.slice(0, -2);
        if (!obj[name]) obj[name] = [];
        obj[name].push(v);
        continue;
      }
      if (obj[k]) {
        if (Array.isArray(obj[k])) obj[k].push(v); else obj[k] = [obj[k], v];
      } else {
        obj[k] = v;
      }
    }

    // ensure ms[], explained[], refused[] are captured even if not using [] name (fallback)
    // (in case checkboxes used name="ms[]" we already handled; otherwise read by name)
    const collectIf = (name) => {
      if (!obj[name]) {
        const els = Array.from(document.querySelectorAll(`[name="${name}"], [name="${name}[]"]`));
        const values = els.filter(el=>el.checked).map(el=>el.value);
        if (values.length) obj[name] = values;
      }
    };
    collectIf('ms');
    collectIf('explained');
    collectIf('refused');

    // signatures as data URLs
    obj.pg_signature_drawn = pgPad.isEmpty() ? null : pgPad.toDataURL();
    obj.wit_signature_drawn = witPad.isEmpty() ? null : witPad.toDataURL();
    obj.prov_signature_drawn = provPad.isEmpty() ? null : provPad.toDataURL();

    return obj;
  }

  // make a nicely formatted email body (Option A style)
  function buildEmailBody(d) {
    const s = (k, v='') => `${k}: ${v}\n`;
    const nl = '\n';
    let out = '';
    out += 'EMS REFUSAL OF MEDICAL CARE & TRANSPORT FORM\n\n';
    out += '----------------------------------------\n1. PATIENT IDENTIFICATION\n----------------------------------------\n';
    out += s('Patient Name', d.patient_name || '') + s('DOB / Age', d.dob_age || '') + s('Address', d.address || '') + s('Phone', d.phone || '');
    out += nl + 'Incident Info\n';
    out += s('Incident Date', d.incident_date||'') + s('Time', d.incident_time||'') + s('Location', d.incident_location||'') + s('EMS Unit', d.ems_unit||'') + s('Provider(s)', d.provider_names||'') + s('Run/Call No.', d.run_number||'');
    out += nl + '----------------------------------------\n2. PATIENT ASSESSMENT\n----------------------------------------\n';
    out += s('Mental Status', Array.isArray(d.ms)? d.ms.join(', ') : (d.ms || '')) ;
    out += 'Vitals:\n';
    out += s('  BP', d.BP||'') + s('  Pulse', d.Pulse||'') + s('  Resp', d.Resp||'') + s('  SpO2', d.SpO2||'') + s('  Glucose', d.Glucose||'') + s('  Temp', d.Temp||'') + s('  GCS', d.GCS||'');
    out += nl + 'Additional Exam:\n' + (d.additional_exam||'') + nl;
    out += nl + '----------------------------------------\n3. TREATMENT & RISKS EXPLAINED\n----------------------------------------\n';
    out += s('Explained', Array.isArray(d.explained)? d.explained.join(', '):(d.explained||'')) + s('Understands Risks', d.understands||'');
    out += nl + '----------------------------------------\n4. SERVICES REFUSED\n----------------------------------------\n';
    out += s('Refused', Array.isArray(d.refused)? d.refused.join(', '):(d.refused||'')) + s('Other', d.refuse_other||'');
    out += nl + '----------------------------------------\n5. PATIENT / GUARDIAN\n----------------------------------------\n';
    out += s('Typed Name', d.pg_name||'') + s('Typed Signature', d.pg_signature||'') + s('Relationship', d.pg_relationship||'');
    out += nl + '----------------------------------------\n6. WITNESS\n----------------------------------------\n';
    out += s('Typed Name', d.wit_name||'') + s('Typed Signature', d.wit_signature||'') + s('Witness Date', d.wit_date||'');
    out += nl + '----------------------------------------\n7. PROVIDER\n----------------------------------------\n';
    out += s('Typed Name', d.prov_name||'') + s('Typed Signature', d.prov_signature||'') + s('Provider Date', d.prov_date||'');
    out += nl + '----------------------------------------\nNARRATIVE\n----------------------------------------\n';
    out += (d.narrative||'') + nl + nl;
    out += 'Signatures included below as images.' + nl;
    return out;
  }

  // submit handler: sends email body + inline signature images (base64)
  document.getElementById('submitBtn').addEventListener('click', async function(){
    const btn = this;
    btn.disabled = true;
    btn.textContent = 'Submitting...';

    try {
      const data = collectFormData();
      const emailBody = buildEmailBody(data);

      // Send to EmailJS (free tier) - template must use {{message}}, and have inline img tags for the signature params
      await emailjs.send('service_29tfekm','template_7777w9f',{
        to_email: 'cbarends@hanson-ma.gov',
        form_subject: 'EMS Refusal Form Submission',
        message: emailBody,
        pg_signature_drawn: data.pg_signature_drawn || '',
        wit_signature_drawn: data.wit_signature_drawn || '',
        prov_signature_drawn: data.prov_signature_drawn || ''
      });

      alert('Form submitted and emailed successfully!');
      document.getElementById('emsForm').reset();
      pgPad.clear(); witPad.clear(); provPad.clear();

    } catch (err) {
      console.error('submit error', err);
      alert('There was an error submitting the form. Check console for details.');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Submit Form';
    }
  });
  </script>
</body>
</html>
