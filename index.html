<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
// Initialize EmailJS
(function(){
    emailjs.init("q0E8zJYxQwO-tPG7H");  // <-- your EmailJS public key
})();

// Initialize signature pads
const pgPad = new SignaturePad(document.getElementById('pg_sign'));
const witPad = new SignaturePad(document.getElementById('wit_sign'));
const provPad = new SignaturePad(document.getElementById('prov_sign'));

function collectFormData() {
    const form = document.getElementById('emsForm');
    const fd = new FormData(form);
    let obj = {};
    
    // collect checkbox groups properly
    fd.forEach((value, key) => {
        if (obj[key]) {
            if (Array.isArray(obj[key])) obj[key].push(value);
            else obj[key] = [obj[key], value];
        } else {
            obj[key] = value;
        }
    });

    // signatures as base64 strings
    obj.pg_signature_drawn = pgPad.isEmpty() ? "(none)" : pgPad.toDataURL();
    obj.wit_signature_drawn = witPad.isEmpty() ? "(none)" : witPad.toDataURL();
    obj.prov_signature_drawn = provPad.isEmpty() ? "(none)" : provPad.toDataURL();

    return obj;
}

function formatEmailBody(data) {
    let emailText = "";
    for (const [key, value] of Object.entries(data)) {
        emailText += `${key}: ${Array.isArray(value) ? value.join(", ") : value}\n`;
    }
    return emailText;
}

document.getElementById("submitBtn").addEventListener("click", async () => {

    const btn = document.getElementById("submitBtn");
    btn.disabled = true;
    btn.textContent = "Submitting...";

    try {
        const dataObj = collectFormData();
        const emailBody = formatEmailBody(dataObj);

        await emailjs.send("service_29tfekm", "template_7777w9f", {
            to_email: "cbarends@hanson-ma.gov",
            form_subject: "EMS Refusal Form Submission",
            message: emailBody,  

            // send images inline (free plan allows this)
            pg_signature_drawn: dataObj.pg_signature_drawn,
            wit_signature_drawn: dataObj.wit_signature_drawn,
            prov_signature_drawn: dataObj.prov_signature_drawn
        });

        alert("Form submitted and emailed successfully!");
        document.getElementById("emsForm").reset();
        pgPad.clear(); witPad.clear(); provPad.clear();

    } catch (err) {
        console.error(err);
        alert("There was an error submitting the form.");
    }

    btn.disabled = false;
    btn.textContent = "Submit Form";
});
</script>
